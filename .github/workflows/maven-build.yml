name: Maven Build and Test

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    # Security: Limit permissions to minimum required
    permissions:
      contents: read
      checks: write
      pull-requests: write
    
    steps:
      # Security: Use pinned version of checkout action
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper versioning
          persist-credentials: false
      
      # Setup Java with proper caching
      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: "25"
          distribution: "temurin"
          cache: maven
          
      # Security: Dependency vulnerability scanning
      - name: Check for Vulnerabilities
        run: |
          mvn dependency-check:check || echo "Dependency check completed with findings"
        continue-on-error: true
      
      # Code Quality Gate 1: Checkstyle validation
      - name: Run Checkstyle Analysis
        run: mvn checkstyle:check --file pom.xml
        
      # Code Quality Gate 2: Spotless formatting check
      - name: Run Spotless Formatting Check
        run: mvn spotless:check --file pom.xml
        
      # Compilation step with error reporting
      - name: Compile Project
        run: mvn -B compile --file pom.xml
        
      # Run tests with proper reporting
      - name: Run Unit Tests
        run: |
          mvn -B test --file pom.xml
          echo "Test execution completed"
          
      # Integration tests
      - name: Run Integration Tests
        run: mvn -B failsafe:integration-test failsafe:verify --file pom.xml
        
      # Package the application
      - name: Package Application
        run: mvn -B package -DskipTests --file pom.xml
        
      # Upload build artifacts
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: markblog-artifacts
          path: |
            target/*.jar
            pom.xml
            README.md
          retention-days: 30
          
      # Security: Cleanup
      - name: Cleanup
        if: always()
        run: |
          echo "Build workflow completed"
          rm -rf ~/.m2/repository/* || true
